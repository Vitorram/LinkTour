<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa e Descobrir</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body, html {
    margin:0;
    padding:0;
    height:100%;
    width:100%;
    font-family: Arial, sans-serif;
    overflow-x:hidden;
}
/* HEADER */
header {
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    padding:10px;
    background:#fff;
    position: sticky;
    top:0;
    z-index:100;
    box-shadow:0 1px 5px rgba(0,0,0,0.1);
}
.headerBtn {
    padding:8px 15px;
    border:none;
    border-radius:20px;
    background:#3b4cca;
    color:#fff;
    font-weight:bold;
    cursor:pointer;
}
.headerBtn.ativo { background:#222; }
/* MAPA */
#mapContainer {
    position: absolute;
    top: 60px;
    bottom: 60px;
    left: 0;
    right: 0;
}
#map { width:100%; height:100%; }
/* DISCOVER */
#discoverSection {
    display:none;
    column-count: 2;
    column-gap: 12px;
    padding:15px;
}
@media(min-width:600px){ #discoverSection { column-count: 3; } }
@media(min-width:900px){ #discoverSection { column-count: 4; } }
#discoverSection .card {
    break-inside: avoid;
    margin-bottom: 12px;
    cursor:pointer;
    border-radius:12px;
    overflow:hidden;
    background:#fff;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
#discoverSection .card img {
    width:100%;
    height:auto;
    display:block;
    border-radius:12px;
    object-fit:cover;
}
/* MODAL */
.feedModal {
    display:none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(255,255,255,0.95);
    z-index:1000;
    flex-direction: column;
    overflow-y:auto;
    padding:20px;
    box-sizing:border-box;
}
.feedHeader {
    display:flex;
    align-items:center;
    padding-bottom:10px;
    border-bottom:1px solid #ddd;
    margin-bottom:10px;
}
.feedBackBtn {
    font-size:24px;
    font-weight:bold;
    cursor:pointer;
    margin-right:10px;
    background:none;
    border:none;
}
.feedContent { display:flex; flex-direction:column; gap:20px; }
/* POST */
.poste {
    border:1px solid #ddd;
    border-radius:12px;
    overflow:hidden;
    background:#fff;
    max-width:500px;
    width:100%;
    margin:0 auto;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.poste .usuario {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px;
}
.poste .usuario .infoUsuario { margin-left:10px; }
.poste .usuario .nomeUsuario { font-weight:bold; font-size:14px; }
.poste .usuario .postadoem { font-size:12px; color:gray; }
.poste .fotoPubli img {
    width:100%; max-height:300px;
    object-fit:cover; border-radius:8px;
}
.poste .desc { font-size:14px; padding:10px; }
.poste .usuario button {
    font-size:13px; padding:5px 10px;
    border:none; border-radius:5px;
    background:#0095f6; color:white;
    cursor:pointer;
}
/* RODAPÉ */
.barraInferior {
    position: fixed;
    bottom: 0;
    width: 100%;
    display:flex;
    justify-content: space-around;
    align-items:center;
    background-color:#fff;
    padding:12px 0;
    border-top:1px solid #ddd;
    z-index:100;
}
.barraInferior a img { width:30px; height:30px; }
.barraInferior a.ativo img { filter: brightness(1.2); }
/* MARKERS */
.blob {
    width: 50px; height: 50px;
    border-radius:100%;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#000;
}
.blob img { width:100%; height:100%; object-fit:cover; }
</style>
</head>
<body>

<header>
  <button id="btnMapa" class="headerBtn ativo">MAPA</button>
  <button id="btnDescobrir" class="headerBtn">DESCOBRIR</button>
</header>

<div id="mapContainer"><div id="map"></div></div>

<div id="discoverSection"></div>

<!-- MODAL -->
<div id="feedModal" class="feedModal">
  <div class="feedHeader">
    <button id="feedBackBtn" class="feedBackBtn">&#8592;</button>
    <span>Explorar</span>
  </div>
  <div class="feedContent" id="feedModalInner"></div>
</div>

<div class="barraInferior">
  <a href="/HTML/home.HTML"><img src="/img/icons8-casa-48.png" alt=""></a>
  <a href="/HTML/mapa.html" class="ativo"><img src="/img/icons8-mapa-50.png" alt=""></a>
  <a href="/HTML/add.html"><img src="/img/icons8-mais-50.png" alt=""></a>
  <a href="/HTML/serv.html"><img src="/img/icons8-parceiro-50.png" alt=""></a>
  <a href="/HTML/perfil.html"><img src="/img/icons8-conta-de-teste-50.png" alt=""></a>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Referências
const mapContainer = document.getElementById('mapContainer');
const discoverSection = document.getElementById('discoverSection');
const btnMapa = document.getElementById('btnMapa');
const btnDescobrir = document.getElementById('btnDescobrir');

// Alternar abas
btnMapa.addEventListener('click', ()=>{
    mapContainer.style.display='block';
    discoverSection.style.display='none';
    btnMapa.classList.add('ativo');
    btnDescobrir.classList.remove('ativo');
});
btnDescobrir.addEventListener('click', ()=>{
    mapContainer.style.display='none';
    discoverSection.style.display='block';
    btnDescobrir.classList.add('ativo');
    btnMapa.classList.remove('ativo');
});

// Inicia mapa
var map = L.map('map').setView([-23.6226, -45.4167], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '© OpenStreetMap'
}).addTo(map);

// Função marker personalizado
function blobMarker(lat, lng, imgUrl, htmlContent){
    return L.marker([lat,lng],{
        icon: L.divIcon({
            className:"",
            html:`<div class="blob"><img src="${imgUrl}"></div>`,
            iconSize:[50,50], iconAnchor:[25,25]
        })
    }).addTo(map).on('click',()=>openFeed(htmlContent));
}

// Modal
const feedModal = document.getElementById('feedModal');
const feedModalInner = document.getElementById('feedModalInner');
const feedBackBtn = document.getElementById('feedBackBtn');

function openFeed(html){
    feedModalInner.innerHTML = html;
    feedModal.style.display = 'flex';
    document.body.style.overflow='hidden';
}
function closeFeed(){
    feedModal.style.display='none';
    document.body.style.overflow='auto';
}
feedBackBtn.addEventListener('click',closeFeed);

// Carregar eventos do localStorage
const eventos = JSON.parse(localStorage.getItem("eventos")) || [];

// Pega a foto do usuário logado
const fotoUsuarioAtual = localStorage.getItem("foto") || "https://via.placeholder.com/100";

// Renderizar eventos
eventos.forEach(ev => {
    const fotoUsuario = ev.fotoUsuario || fotoUsuarioAtual;

    const card = document.createElement("div");
    card.classList.add("card");
    card.innerHTML = `<img src="${ev.imagem}" alt="${ev.nome}">`;
    
    const htmlPost = `
    <div class="poste">
      <div class="usuario">
        <div style="display:flex; align-items:center;">
          <div class="fotoUsuario">
            <img src="${fotoUsuario}" 
                 style="width:40px;height:40px;border-radius:50%;">
          </div>
          <div class="infoUsuario">
            <div class="nomeUsuario">${ev.usuario}</div>
            <div class="postadoem">${ev.postadoem}</div>
          </div>
        </div>
        <button>Seguir</button>
      </div>
      <div class="fotoPubli">
        <img src="${ev.imagem}">
      </div>
      <div class="desc">
        <b>${ev.nome}</b><br>${ev.desc}<br>
        <small>${ev.endereco} - ${ev.hora} - ${ev.valor}</small>
      </div>
    </div>`;

    card.addEventListener("click", ()=>openFeed(htmlPost));
    discoverSection.appendChild(card);

    if(ev.lat && ev.lng){
        blobMarker(ev.lat, ev.lng, ev.imagem, htmlPost);
    }
});
</script>

</body>
</html>
